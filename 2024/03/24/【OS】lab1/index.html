<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="lab1实验笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="【OS】lab1">
<meta property="og:url" content="http://example.com/2024/03/24/%E3%80%90OS%E3%80%91lab1/index.html">
<meta property="og:site_name" content="碳罐堆积处">
<meta property="og:description" content="lab1实验笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/%E3%80%90OS%E3%80%91lab1/image-20240324172822728.png">
<meta property="og:image" content="http://example.com/images/%E3%80%90OS%E3%80%91lab1/image-20240324151755768.png">
<meta property="og:image" content="http://example.com/images/%E3%80%90OS%E3%80%91lab1/image-20240327160424612.png">
<meta property="article:published_time" content="2024-03-24T06:30:24.000Z">
<meta property="article:modified_time" content="2024-04-12T12:23:00.167Z">
<meta property="article:author" content="Carbon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/%E3%80%90OS%E3%80%91lab1/image-20240324172822728.png">


<link rel="canonical" href="http://example.com/2024/03/24/%E3%80%90OS%E3%80%91lab1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/03/24/%E3%80%90OS%E3%80%91lab1/","path":"2024/03/24/【OS】lab1/","title":"【OS】lab1"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【OS】lab1 | 碳罐堆积处</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">碳罐堆积处</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90ELF"><span class="nav-number">1.</span> <span class="nav-text">解析ELF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BD"><span class="nav-number">2.</span> <span class="nav-text">内核加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E7%94%9F%E6%88%90%E5%92%8C%E5%85%A5%E5%8F%A3"><span class="nav-number">3.</span> <span class="nav-text">内核生成和入口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#printk"><span class="nav-number">4.</span> <span class="nav-text">printk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85"><span class="nav-number">5.</span> <span class="nav-text">其他知识点补充</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Carbon</p>
  <div class="site-description" itemprop="description">还没想出高级的博客名；出现问题欢迎交流指正喵。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/24/%E3%80%90OS%E3%80%91lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Carbon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="碳罐堆积处">
      <meta itemprop="description" content="还没想出高级的博客名；出现问题欢迎交流指正喵。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【OS】lab1 | 碳罐堆积处">
      <meta itemprop="description" content="lab1实验笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【OS】lab1
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-24 14:30:24" itemprop="dateCreated datePublished" datetime="2024-03-24T14:30:24+08:00">2024-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-12 20:23:00" itemprop="dateModified" datetime="2024-04-12T20:23:00+08:00">2024-04-12</time>
    </span>

  
</div>

            <div class="post-description">lab1实验笔记</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="解析ELF"><a href="#解析ELF" class="headerlink" title="解析ELF"></a>解析ELF</h2><p><code>tools/readelf</code>实现的功能是解析<code>ELF</code>文件。本次练习旨在为链接器链接目标文件提供信息，所以只从节（section）的角度解析而不关心段（segment)。</p>
<p><code>elf.h</code>中声明了三个结构体：<code>Elf32_Ehdr</code>, <code>Elf32_Shdr</code>和<code>Elf32_Phdr</code>，分别为<code>ELF</code>头，节头表表项和段头表表项。</p>
<p><code>readelf.c</code>文件首先有<code>is_elf_format()</code>验证<code>const void * binary</code>是否为<code>elf</code>格式。然后是<code>readelf()</code>遍历节头表，输出每个节头的索引和地址。</p>
<p><img src="/images/【OS】lab1/image-20240324172822728.png" alt="image-20240324172822728"></p>
<p>lab1中给出的是对32-bit little-endian ELF文件的解析程序。</p>
<p>使用内置<code>readelf -l + &lt;file&gt;</code> 可以看到各段的信息。首先展现的程序头应该就是各段的信息，Offset是该段数据相对于ELF文件偏移，<code>VirtAddr</code>表示该段需要被加载到内存的哪个位置，<code>FileSiz</code>是该段数据在文件中的长度，<code>MemSiz</code>会比<code>FileSiz</code>大，其表示该段数据在内存中所应该占的大小（OS在加载时会把未初始化的全局变量所占内存填0）。</p>
<h2 id="内核加载"><a href="#内核加载" class="headerlink" title="内核加载"></a>内核加载</h2><p>QEMU按照内核这一可执行文件所记录的地址，将内核中代码数据等加载到相应位置，并把CPU控制权给内核。</p>
<p>我们需要确定这个相应位置到底是哪里，以及如何修改段所在位置。</p>
<p>MIPS体系结构中将虚拟地址划分为4个区域，结论是内核是在<code>kseg0</code>上。</p>
<ul>
<li><code>kuseg</code>用户态下唯一可用地址空间（内核态也可用）需要通过MMU中的TLB进行虚拟地址到物理地址的变化，存取会通过cache</li>
<li><code>kseg0</code>MMU将虚拟地址最高位清零就得到物理地址用于访存</li>
<li><code>kseg1</code>MMU将虚拟地址高三位清零得到物理地址用于访存，但不通过cache，而是使用MMIO技术访问外设</li>
<li><code>kseg2</code>同<code>kuseg</code>，但只能在内核态下使用</li>
</ul>
<p>指导书接下来甩出来一个MMU内存分配图，一开始没看懂，后来发现其实就是MIPS内存布局的细化版，<code>kseg0</code>紧接在<code>kuseg</code>上面。这里在补全代码的时候先看一眼<code>include/mmu.h</code>的内容就会发现地址都不用算的，全都宏定义好了。</p>
<p><img src="/images/【OS】lab1/image-20240324151755768.png" alt="image-20240324151755768"></p>
<p>分析ELF文件时发现，编译器在生成ELF文件时就已经知道了各节需要加载的位置。这个“知道”是因为链接器在产生可执行文件时有<code>.lds</code>文件指导。lab1第二个练习就是补全<code>kernel.lds</code>中的内容。</p>
<p>这里着重强调了<code>kernel.lds</code>中两部分内容。一个是其指定<code>.text, .data, .bss</code>三个节所在位置。这三个节分别保存可执行文件的操作指令、已初始化的全局变量和静态变量、未初始化的全局变量和静态变量。通过上图可以找到<code>.text</code>段加载地址是<code>0x8002 0000</code>，<code>.data</code>和<code>.bss</code>紧随其后即可。</p>
<p>这里按照格式写就可以，单独划分的<code>bss_start、bss_end、end</code>应该是在其他地方有用。</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">SECTIONS {</span><br><span class="line">	. = <span class="number">0x80020000</span>;</span><br><span class="line">	<span class="meta">.text</span> : { *(<span class="meta">.text</span>) }</span><br><span class="line">	<span class="meta">.data</span> : { *(<span class="meta">.data</span>) }</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bss_start </span>= .;</span><br><span class="line">	.<span class="keyword">bss </span>: { *(.<span class="keyword">bss) </span>}</span><br><span class="line">	<span class="keyword">bss_end </span>= .;</span><br><span class="line">	. = <span class="number">0x80400000</span>;</span><br><span class="line">	end = . ;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>还有一个强调了<code>kernel.lds</code>通过<code>ENTRY(_start)</code>设置程序入口。</p>
<h2 id="内核生成和入口"><a href="#内核生成和入口" class="headerlink" title="内核生成和入口"></a>内核生成和入口</h2><p>为了研究内核生成，需要先看看<code>Makefile</code>：</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">targets := <span class="variable">$(mos_elf)</span></span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(targets)</span></span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(modules)</span>: tools</span><br><span class="line">	<span class="variable">$(MAKE)</span> --directory=<span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(mos_elf)</span>: <span class="variable">$(modules)</span> <span class="variable">$(target_dir)</span></span><br><span class="line">	<span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -o <span class="variable">$(mos_elf)</span> -N -T <span class="variable">$(link_script)</span> <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure>
<p>简单理解就是为生成内核，<code>make</code>先构建<code>$(modules)</code>，这里包含<code>lib, init, kern</code>三个构建目标，分别对应系统依赖库，初始化代码和内核代码。然后调用链接器<code>$(link_script)</code>链接<code>$(objects)</code>。</p>
<p>这里<code>$(modules)</code>和<code>$(objects)</code>有一个转换，因为在后面的lab会逐渐解锁<code>$(user_modules)</code>，二者链接方式不同。</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">objects                 := <span class="variable">$(<span class="built_in">addsuffix</span> /*.o, <span class="variable">$(modules)</span>)</span> <span class="variable">$(<span class="built_in">addsuffix</span> /*.x, <span class="variable">$(user_modules)</span>)</span></span><br><span class="line">modules                 += <span class="variable">$(user_modules)</span></span><br></pre></td></tr></table></figure>
<p><code>init</code>目录作用是初始化内核。<code>start.S</code>中<code>_start</code>函数是CPU控制权被转交给内核后执行的第一个函数，主要是初始化CPU和栈指针，并跳转到<code>init.c</code>文件中<code>mips_init</code>函数（有关该函数的具体内容在lab2介绍，指导书中提了一嘴说内核中各模块初始化函数会在这里被调用）。</p>
<h2 id="printk"><a href="#printk" class="headerlink" title="printk"></a>printk</h2><p>这里介绍的挺复杂，看看提到的三个文件：</p>
<ul>
<li><code>kern/machine.c</code>：这个文件负责往QEMU的控制台输出字符，其原理为读写某一个特殊的内存地址。</li>
<li><p><code>kern/printk.c</code>：此文件中，实现了<code>printk</code>，但其所做的，实际上是把输出字符的函数，接受的输出参数给传递给了<code>vprintfmt</code>这个函数。</p>
</li>
<li><p><code>lib/print.c</code>：此文件中，实现了<code>vprintfmt</code>函数，其实现了格式化输出的主体逻辑。</p>
</li>
</ul>
<p>四舍五入只需要研究<code>lib/print.c</code>中的<code>vprintfmt</code>函数，但在此之前先关注一下其参数列表：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vprintfmt</span><span class="params">(<span class="type">fmt_callback_t</span> out, <span class="type">void</span> *data, <span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span>;</span><br></pre></td></tr></table></figure>
<p>顺着找<code>print.h</code>发现有对<code>fmt_callback_t</code>的声明：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">fmt_callback_t</span>)</span><span class="params">(<span class="type">void</span> *data, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> len)</span>;</span><br></pre></td></tr></table></figure>
<p>意思是用<code>fmt_callback_t</code>代指<code>void (*)(void *data, const char *buf, size_t len)</code>这样的函数指针，该函数接受三个参数，不返回任何值。</p>
<p>单看命名方式猜不出来<code>void *data</code>和<code>const char *fmt</code>是什么意思，看看<code>kern/printk.c</code>里写了什么</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">outputk</span><span class="params">(<span class="type">void</span> *data, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> {</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) {</span><br><span class="line">		printcharc(buf[i]);</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printk</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fmt, ...)</span> {</span><br><span class="line">	va_list ap;</span><br><span class="line">	va_start(ap, fmt);</span><br><span class="line">    <span class="comment">//void va_start(va_list ap, parmN) 第二个参数是首个可变形参前的具名形参</span></span><br><span class="line">    <span class="comment">//其实就是告诉一下哪里是变参开始的地方</span></span><br><span class="line">	vprintfmt(outputk, <span class="literal">NULL</span>, fmt, ap);</span><br><span class="line">	va_end(ap);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这里大概就能猜到<code>printk</code>做了什么：给<code>vprintfmt</code>提供真正能打印的函数入口，（data到底是啥还是不清楚，好像一直都是NULL），待打印的内容的起始地址和变长参数列表。</p>
<p>还可以发现<code>kern/printk.c</code>里有这样的代码：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">printk(<span class="string">"HI  = %08x\n"</span>, tf-&gt;hi);</span><br></pre></td></tr></table></figure>
<p>这样看就是调到同文件下的<code>printk()</code>里，<code>fmt</code>就是带格式的待打印的内容，具体打印给<code>lib/print.c</code>中的<code>vprintfmt()</code>。这个函数有一个巨长的for循环，是在挨个遍历这些字符，如果没碰到格式符就直接打印；如果遇到格式符，就按照格式符表示的内容获取参数（变长参数表在知道参数类型后才能取参数）和打印格式。嗯看懂了还是挺帅的。</p>
<p>本作业中打印限制了格式符原型。flag若为负号则是左对齐，否则默认右对齐；若为0则填充符为0，注意设置默认是空格。length限制只有<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.674ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 298 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g></g></g></svg></mjx-container>。specifier具体见指导书吧。</p>
<p>$\%[flags][width][length]<specifier>$</specifier></p>
<p>代码填空重点关注了<code>print_num</code>函数</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">print_num</span><span class="params">(<span class="type">fmt_callback_t</span> out, <span class="type">void</span> *data, <span class="type">unsigned</span> <span class="type">long</span> u, <span class="type">int</span> base, <span class="type">int</span> neg_flag, <span class="type">int</span> length, <span class="type">int</span> ladjust, <span class="type">char</span> padc, <span class="type">int</span> upcase)</span></span><br></pre></td></tr></table></figure>
<p>随便结合一个调用看</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'u'</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'U'</span>:</span><br><span class="line">	<span class="keyword">if</span> (long_flag) {</span><br><span class="line">		num = va_arg(ap, <span class="type">long</span> <span class="type">int</span>);</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		num = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">	}</span><br><span class="line">	print_num(out, data, num, <span class="number">10</span>, <span class="number">0</span>, width, ladjust, padc, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>前两个参数和<code>vprintfmt</code>参数一致，<code>u</code>是按类型取出的参数，<code>base</code>是数制的基底，其他的直接看名字。</p>
<p><code>print_num</code>算法是：</p>
<ul>
<li>先从低位到高位打印（比如1234顺序就是4 3 2 1）</li>
<li>剩余位置填充<code>pedc</code></li>
<li>如果为默认右对齐，就整个字符串都翻转输出</li>
<li>否则就只翻转目标字符串</li>
</ul>
<p>可以发现，这里的<code>u</code>都是按照正数处理的。所以在补全代码的时候判断其为负号了，不仅要改<code>neg_flag</code>的值，还要有<code>num = -num</code></p>
<h2 id="其他知识点补充"><a href="#其他知识点补充" class="headerlink" title="其他知识点补充"></a>其他知识点补充</h2><p><strong>大小端</strong></p>
<p><img src="/images/【OS】lab1/image-20240327160424612.png" alt="image-20240327160424612"></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Carbon
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/2024/03/24/%E3%80%90OS%E3%80%91lab1/" title="【OS】lab1">http://example.com/2024/03/24/【OS】lab1/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/02/29/%E3%80%90OO%E3%80%91hw1/" rel="prev" title="【OO】hw1">
                  <i class="fa fa-angle-left"></i> 【OO】hw1
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/04/07/%E3%80%90OS%E3%80%91lab2/" rel="next" title="【OS】lab2">
                  【OS】lab2 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Carbon</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
